#!/usr/bin/env bash
# Installs git hooks to automatically run .ai/sync/sync.sh on checkout and merge.

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DEFAULT_REPO_ROOT="$(cd "$SCRIPT_DIR/../../" && pwd)"
REPO_ROOT="${AGENTSYNC_REPO_ROOT:-$DEFAULT_REPO_ROOT}"

if [[ ! -d "$REPO_ROOT" ]]; then
    echo "Error: Repository root not found: $REPO_ROOT" >&2
    exit 1
fi

REPO_ROOT="$(cd "$REPO_ROOT" && pwd)"
HOOKS_DIR="$REPO_ROOT/.git/hooks"

# Ensure hooks directory exists
if [[ ! -d "$HOOKS_DIR" ]]; then
    echo "Error: .git/hooks directory not found. Are you in a git repository?"
    exit 1
fi

HOOK_SCRIPT="#!/bin/sh
# Auto-generated by .ai/sync/setup_hooks.sh
# Syncs AI configs after a merge or checkout to ensure local tools are up to date.

if [ -f \".ai/system/sync.sh\" ]; then
    echo \"Running AI Config Sync...\"
    .ai/system/sync.sh
fi
"

# Install post-merge hook
echo "$HOOK_SCRIPT" > "$HOOKS_DIR/post-merge"
chmod +x "$HOOKS_DIR/post-merge"
echo "Installed post-merge hook."

# Install post-checkout hook
echo "$HOOK_SCRIPT" > "$HOOKS_DIR/post-checkout"
chmod +x "$HOOKS_DIR/post-checkout"
echo "Installed post-checkout hook."

echo "Git hooks installed successfully! AI configs will now sync automatically on pull/checkout."
